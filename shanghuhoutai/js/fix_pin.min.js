/*By 任龙飞—renlongfei*/
var height=$(window).height(),push_stu=0;$(".body-left").css({height:height});var banner,details_img,maxFileCount1=0,maxFileCount2=0,invoice_type="无",All=[];function setdata(i,n){$(i).find("input").val(n)}function view(i,n){$(n).html("");for(var t=0;t<i.length;t++)$(n).append('<img src="'+i[t]+'" alt="" width="100%">')}function edit(i){$("body").on("click",i,function(){$(this).prop("readonly",!1)})}function readonly(i){$("body").on("blur",i,function(){$(this).prop("readonly",!0)})}function img_number(i){if("8"!==token)switch(i){case banner:0===(maxFileCount1=5-i.length<=0?0:5-i.length)?$("#loading").css({display:"none"}):$("#loading").css({display:"block"});break;case details_img:0===(maxFileCount2=10-i.length<=0?0:5-i.length)?$("#uploading").css({display:"none"}):$("#loading").css({display:"block"})}}function sort_img(i,n){$(n).html(""),i.forEach(function(i,t){$(n).append('<div class="show-img-con"><div class="last"><</div><img src="'+i+'" alt="" width=\'100%\'><div class="next">></div><div class="loading-show-img-del"><img src="images/del.png" alt="" width=\'100%\'></div></div>')})}function arrow_show(i,n,t){switch(n){case"mouseover":var a=0;break;case"mouseleave":a="-20px"}$(i).on(n,t,function(){$(this).find(".last").stop(!0).animate({left:a},300),$(this).find(".next").stop(!0).animate({right:a},300)})}function ArrChange(i,n,t){switch(i){case 0:t>0&&(n.splice(t-1,0,n[t]),n.splice(t+1,1));break;case 1:t<n.length-1&&(n.splice(t+2,0,n[t]),n.splice(t,1))}}function del_img(i,n,t){switch(t.splice(i,1),img_number(t),t){case banner:view(t,".loading-preview-con"),sort_img(t,".loading-show-img");break;case details_img:view(t,".uploading-preview-con"),sort_img(t,".uploading-show-img")}}var pid=localStorage.getItem("fix"),active=localStorage.getItem("isactive");$.post(localhost+"/tuan/tdelivertemplates/list",{saleId:token,online_code:onlinecode},function(i){outline(i);for(var n=i.data,t=0;t<n.length;t++)$("select").append("<option>"+n[t].dname+'<div class="deliverid" style=" display: none">='+n[t].id+"</div></option>")}),$.post(localhost+"/tuan/product/findone",{pid:pid,saleId:token,active:active,online_code:onlinecode},function(i){outline(i);var n=i.data,t=n.style,a=n.types,l=n.productsTypes,e=n.parameters,s=n.tuanNumbers,o=n.tuanTimes;banner=n.indexPic.split(","),details_img=n.detailPic.split(",");var p=[],c={},d=[];if(img_number(banner),img_number(details_img),setdata(".title",n.pname),setdata(".kuanhao",n.pNumber),setdata(".classify",n.ptypeName),view(banner,".loading-preview-con"),view(details_img,".uploading-preview-con"),sort_img(banner,".loading-show-img"),sort_img(details_img,".uploading-show-img"),$(".kuanhao input").val(t),$(".classify input").val(a),$(".canshu textarea").val(e),$(".pdan-num input").val(s),$(".pdan-time input").val(o),null!==n.startDate){var r=n.startDate;$(".pdan-start").find("input").eq(0).val(r.split(" ")[0]),$(".pdan-start").find("input").eq(1).val(r.split(" ")[1].split(":")[0]),$(".pdan-start").find("input").eq(2).val(r.split(" ")[1].split(":")[1])}if(null!==n.endDate){var u=n.endDate;$(".pdan-end").find("input").eq(0).val(u.split(" ")[0]),$(".pdan-end").find("input").eq(1).val(u.split(" ")[1].split(":")[0]),$(".pdan-end").find("input").eq(2).val(u.split(" ")[1].split(":")[1])}l.forEach(function(i,n){c[i.color]||(p.push(i.color),c[i.color]=1)}),p.forEach(function(i,n){l.forEach(function(n,t){i===n.color&&(d.push({}),d[t].color=n.color,d[t].amount=n.amount,d[t].newPrice=n.newPrice,d[t].size=n.size,d[t].oldPrice=n.oldPrice,d[t].tuanPrice=n.tuanPrice)})}),p.forEach(function(i,n){$(".sure").append('<div class="all">\n                <div class="all-top">\n                    <ul>\n                        <li style="width: 90px">颜色</li>\n                        <li>尺码</li>\n<li style="position: relative" class="jia"><span style="cursor: pointer">原价<span style="font-size: 12px;display: block">(双击一键添加)</span></span><input type="text" style="height: 100%;width: 64%;position: absolute;left:0;top:0;margin-left: 25px;opacity: 0;cursor: pointer;text-align: center"></li>                        <li style="position: relative" class="djia">\n                            <span style="cursor: pointer;display: block">单独价\n                                <span style="font-size: 12px;display: block">(双击一键添加)</span>\n                            </span>\n                            <input type="text" style="height: 100%;width: 64%;position: absolute;\nleft:0;top:0;margin-left: 25px;opacity: 0;cursor: pointer;text-align: center">\n                        </li>\n<li style="position: relative" class="pjia">\n                            <span style="cursor: pointer;display: block">拼单价\n                                <span style="font-size: 12px;display: block">(双击一键添加)</span>\n                            </span>\n                            <input type="text" style="height: 100%;width: 64%;position: absolute;\nleft:0;top:0;margin-left: 25px;opacity: 0;cursor: pointer;text-align: center">\n                        </li>\n                        <li style="position: relative" class="cunliang">\n                            <span>库存\n                                <span style="font-size: 12px;display: block">(双击一键添加)</span>\n                            </span>\n                            <input type="text" style="height: 100%;width: 64%;position: absolute;\nleft:0;top:0;margin-left: 25px;opacity: 0;cursor: pointer;text-align: center">\n                        </li>\n                    </ul>\n                </div>                <div class="all-con">\n                    <div class="all-con-left">\n                        <input type="text"  readonly class="clickdb">\n                    </div>\n                    <div class="all-con-right">\n                        <ul>\n                        </ul>\n<div class="add_"><img src="images/add.png" alt=""></div>                    </div>\n                    <div class="del">\n                        <img src="images/del.png" alt="">\n                    </div>\n                </div>\n            </div>'),$(".all").eq(n).find(".all-con-left input").val(i),d.forEach(function(t,a){i===t.color&&$(".all").eq(n).find(".all-con-right ul").eq(0).append('<li>\n                                <ul class="push-details">\n                                    <li><span>\n                                      <input type="text" placeholder=\'列如："S"\' class="chima" readonly value='+d[a].size+'>\n                                </span></li>\n                <li><input type="text" readonly class="clickdb jiage" value='+d[a].oldPrice+'></li><li><input type="text" readonly class="clickdb djiage" value='+d[a].newPrice+'></li><li><input type="text" readonly class="clickdb pjiage" value='+d[a].tuanPrice+'></li> <li><input type="text" readonly class="clickdb nums" value='+d[a].amount+'></li><div class="del_"><img src="images/del.png" alt=""></div>                                </ul>\n                            </li>')})}),$(".address").find("textarea").val(n.sendAddress),$.post(localhost+"/tuan/types/list",{saleId:token,online_code:onlinecode},function(i){if(outline(i),null!==i.data){for(var n=i.data.types.split(","),t=0;t<n.length;t++)$(".span").append('<div class="span-span"><div class="last"><</div><div class="next">></div><span>'+n[t]+"</span></div>");arrow_show(".span","mouseover",".span-span"),arrow_show(".span","mouseleave",".span-span"),$(".span").on("click",".last",function(){var i=$(this).parents(".span-span").index();ArrChange(0,n,i),$(".span").html("");for(var t=0;t<n.length;t++)$(".span").append('<div class="span-span"><div class="last"><</div><div class="next">></div><span>'+n[t]+"</span></div>");return!1}),$(".span").on("click",".next",function(){var i=$(this).parents(".span-span").index();ArrChange(1,n,i),$(".span").html("");for(var t=0;t<n.length;t++)$(".span").append('<div class="span-span"><div class="last"><</div><div class="next">></div><span>'+n[t]+"</span></div>");return!1}),$(".button").click(function(){$.post(localhost+"/tuan/types/update",{saleId:token,typenames:n.join(",")},function(i){})})}}),$(".span").on("click",".span-span",function(){$(".span").siblings(".classify").find("input").val($(this).find("span").text())}),arrow_show(".loading-show-img","mouseover",".show-img-con"),arrow_show(".uploading-show-img","mouseover",".show-img-con"),arrow_show(".loading-show-img","mouseleave",".show-img-con"),arrow_show(".uploading-show-img","mouseleave",".show-img-con"),$(".loading-show-img").on("click",".last",function(){var i=$(this).parents(".show-img-con").index();ArrChange(0,banner,i),view(banner,".loading-preview-con"),sort_img(banner,".loading-show-img")}),$(".loading-show-img").on("click",".next",function(){var i=$(this).parents(".show-img-con").index();ArrChange(1,banner,i),view(banner,".loading-preview-con"),sort_img(banner,".loading-show-img")}),$(".uploading-show-img").on("click",".last",function(){var i=$(this).parents(".show-img-con").index();ArrChange(0,details_img,i),view(details_img,".uploading-preview-con"),sort_img(details_img,".uploading-show-img")}),$(".uploading-show-img").on("click",".next",function(){var i=$(this).parents(".show-img-con").index();ArrChange(1,details_img,i),view(details_img,".uploading-preview-con"),sort_img(details_img,".uploading-show-img")}),$("body").on("click",".loading-show-img-del",function(){var i=$(this).parents().parents()[0].className,n=$(this).parents().index();switch(i){case"loading-show-img":del_img(n,".show-img-con",banner),img_number(banner);break;case"uploading-show-img":del_img(n,".show-img-con",details_img),img_number(details_img)}}),edit(".chima"),readonly(".chima"),edit(".clickdb"),readonly(".clickdb"),$("body").on("click",".del",function(){$(".del").length>1&&$(this).parents(".all").remove()}),$("body").on("click",".del_",function(){$(this).parents(".all-con-right").find(".push-details").length>1&&$(this).parents(".push-details").parents("li").remove()}),$("body").on("click",".all-top .jia",function(){$(this).find("input").css({opacity:1}).siblings("span").css({opacity:0})}),$("body").on("click",".all-top .djia",function(){$(this).find("input").css({opacity:1}).siblings("span").css({opacity:0})}),$("body").on("click",".all-top .pjia",function(){$(this).find("input").css({opacity:1}).siblings("span").css({opacity:0})}),$("body").on("blur",".all-top .jia",function(){var i=$(this).find("input").val(),n=$(this).parents(".all").index();$(this).find("input").css({opacity:0}).siblings("span").css({opacity:1}),$(".all-con-right").eq(n).find(".jiage").val(i)}),$("body").on("blur",".all-top .djia",function(){var i=$(this).find("input").val(),n=$(this).parents(".all").index();$(this).find("input").css({opacity:0}).siblings("span").css({opacity:1}),$(".all-con-right").eq(n).find(".djiage").val(i)}),$("body").on("blur",".all-top .pjia",function(){var i=$(this).find("input").val(),n=$(this).parents(".all").index();$(this).find("input").css({opacity:0}).siblings("span").css({opacity:1}),$(".all-con-right").eq(n).find(".pjiage").val(i)}),$("body").on("click",".all-top .cunliang",function(){$(this).find("input").css({opacity:1}).siblings("span").css({opacity:0})}),$("body").on("blur",".all-top .cunliang",function(){var i=$(this).find("input").val(),n=$(this).parents(".all").index();$(this).find("input").css({opacity:0}).siblings("span").css({opacity:1}),$(".all-con-right").eq(n).find(".nums").val(i)}),$("body").on("click",".add_",function(){$(this).siblings("ul").append('<li>\n                                <ul class="push-details">\n                                    <li><span>\n                                      <input type="text" placeholder=\'列如："S"\' class="chima">\n                                </span></li>\n                <li><input type="text" readonly class="clickdb jiage"></li><li><input type="text" readonly class="clickdb djiage"></li><li><input type="text" readonly class="clickdb pjiage"></li> <li><input type="text" readonly class="clickdb nums"></li><div class="del_"><img src="images/del.png" alt=""></div>                                </ul>\n                            </li>')}),$(".add").click(function(){$(".sure").append('<div class="all">\n                <div class="all-top">\n                    <ul>\n                        <li style="width: 90px">颜色</li>\n                        <li>尺码</li>\n<li style="position: relative" class="jia"><span style="cursor: pointer">原价<span style="font-size: 12px;display: block">(双击一键添加)</span></span><input type="text" style="height: 100%;width: 64%;position: absolute;left:0;top:0;margin-left: 25px;opacity: 0;cursor: pointer;text-align: center"></li>                        <li style="position: relative" class="djia">\n                            <span style="cursor: pointer;display: block">单独价\n                                <span style="font-size: 12px;display: block">(双击一键添加)</span>\n                            </span>\n                            <input type="text" style="height: 100%;width: 64%;position: absolute;\nleft:0;top:0;margin-left: 25px;opacity: 0;cursor: pointer;text-align: center">\n                        </li>\n<li style="position: relative" class="pjia">\n                            <span style="cursor: pointer;display: block">拼单价\n                                <span style="font-size: 12px;display: block">(双击一键添加)</span>\n                            </span>\n                            <input type="text" style="height: 100%;width: 64%;position: absolute;\nleft:0;top:0;margin-left: 25px;opacity: 0;cursor: pointer;text-align: center">\n                        </li>\n                        <li style="position: relative" class="cunliang">\n                            <span>库存\n                                <span style="font-size: 12px;display: block">(双击一键添加)</span>\n                            </span>\n                            <input type="text" style="height: 100%;width: 64%;position: absolute;\nleft:0;top:0;margin-left: 25px;opacity: 0;cursor: pointer;text-align: center">\n                        </li>\n                    </ul>\n                </div>\n                <div class="all-con">\n                    <div class="all-con-left">\n                        <input type="text"  readonly class="clickdb">\n                    </div>\n                    <div class="all-con-right">\n                        <ul>\n<li>\n                                <ul class="push-details">\n                                    <li><span>\n                                      <input type="text" placeholder=\'列如："S"\' class="chima">\n                                </span></li>\n                <li><input type="text" readonly class="clickdb jiage"></li>                <li><input type="text" readonly class="clickdb djiage"></li><li><input type="text" readonly class="clickdb pjiage"></li> <li><input type="text" readonly class="clickdb nums"></li><div class="del_"><img src="images/del.png" alt=""></div>                                </ul>\n                            </li>                        </ul>\n<div class="add_"><img src="images/add.png" alt=""></div>                    </div>\n                    <div class="del">\n                        <img src="images/del.png" alt="">\n                    </div>\n                </div>\n            </div>')}),$(".sure").on("input","input",function(){All=[],$(".button").html("保存")}),$(".button").click(function(){try{$(".sure").find(".all-con-left input").each(function(i,n){if(""===n.value)return alert("有颜色栏未填写，如不需要请点击右上角删除！"),!1})}catch(i){}try{$(".sure").find(".all-con-right span input").each(function(i,n){if(""===n.value)return alert("有尺寸栏未填写，如不需要请点击右上角删除！"),!1})}catch(i){}All=[];for(var i=0,n=0;n<$(".disjiage").length;n++)if($(".disjiage").eq(n).val()<=0)return alert("折扣价不得为0！"),!1;for(var t=0;t<$(".all-con-right").find("input").length;t++)""==$(".all-con-right").find("input").eq(t).val()&&i++;if(i>0){if(!confirm("你所填写的信息中有空白，点击确定自动补全为0或填写完整！"))return!1;for(t=0;t<$(".all-con-right").find("input").length;t++)""==$(".all-con-right").find("input").eq(t).val()&&$(".all-con-right").find("input").eq(t).val("0")}for(var a=0;a<$(".all-con-left").length;a++)for(var l=0;l<$(".all-con-right").eq(a).find(".push-details input").length;l+=5)All.push($(".all-con-left").find("input").eq(a).val()+","+$(".all-con-right").eq(a).find("input").eq(l).val()+","+$(".all-con-right").eq(a).find("input").eq(l+1).val()+","+$(".all-con-right").eq(a).find("input").eq(l+2).val()+","+$(".all-con-right").eq(a).find("input").eq(l+3).val()+","+$(".all-con-right").eq(a).find("input").eq(l+4).val());$(".button").html("已保存！")}),$("body").on("click",".btn",function(){"none"===$("#loading").css("display")&&($(".hint-page").fadeIn().html("图片数量已打上限，请删除后重试！"),setTimeout(function(){$(".hint-page").fadeOut().html("")},1500))}),$("#loading").fileinput({language:"zh",uploadUrl:localhost+"/tuan/product/uploadPic",allowedFileExtensions:["jpg","png","gif"],maxFileCount:maxFileCount1,enctype:"multipart/form-data",showUpload:!0,showCaption:!1,uploadAsync:!1,browseClass:"btn btn-primary",previewFileIcon:"<i class='glyphicon glyphicon-king'></i>",uploadExtraData:function(i,n){var t={};return t.saleId=token,t.online_code=onlinecode,t}}).on("filebatchuploadsuccess",function(i,n){if(""!==n.response.data||void 0!==n.response.data){n.response.data.split(",").forEach(function(i,n){banner.push(i)}),img_number(banner),sort_img(banner,".loading-show-img"),view(banner,".loading-preview-con")}}),$("#uploading").fileinput({language:"zh",uploadUrl:localhost+"/tuan/product/uploadPic",allowedFileExtensions:["jpg","png","gif"],maxFileCount:maxFileCount2,enctype:"multipart/form-data",showUpload:!0,showCaption:!1,uploadAsync:!1,browseClass:"btn btn-primary",previewFileIcon:"<i class='glyphicon glyphicon-king'></i>",uploadExtraData:function(i,n){var t={};return t.saleId=token,t.online_code=onlinecode,t}}).on("filebatchuploadsuccess",function(i,n){if(""!==n.response.data||void 0!==n.response.data){n.response.data.split(",").forEach(function(i,n){details_img.push(i)}),img_number(details_img),sort_img(details_img,".uploading-show-img"),view(details_img,".uploading-preview-con")}});var g="";$(".express").click(function(){$(this).is(":checked")?(g=null,$("select").val("选择快递模板")):g=$("select option:selected").html().split("=")[1]}),$("select").click(function(){"选择快递模板"===$("select option:selected").text()?(g=null,$(".express").prop("checked",!0)):(g=$("select option:selected").html().split("=")[1],$(".express").prop("checked",!1))}),$('input[type="number"]').blur(function(){var i=parseInt($(this).val());if("NaN"===i.toString())return alert("你输入的格式有误！"),$(this).val("0"),!1;i<0&&$(this).val("0")}),$(".fabu").click(function(){var i=details_img.join(","),t=banner.join(","),a=$(".title").find("input").val(),l=$(".classify").find("input").val(),e=$(".kuanhao").find("input").val(),s=$(".tjbianji").find("input").val(),o=($(".address .input textarea").val(),$(".kuaidi").eq(1).find("input:checked").siblings("span").html(),$(".canshu").find("input").eq(0).val(),$(".canshu").find("input").eq(1).val(),$(".canshu").find("input").eq(3).val(),$(".canshu").find("input").eq(4).val(),$(".canshu").find("input").eq(5).val(),$(".canshu").find("input").eq(6).val(),$(".canshu textarea").val()),p=""===$(".pdan-num input").val()?0:$(".pdan-num input").val(),c=""===$(".pdan-time input").val()?0:$(".pdan-time input").val(),d=$(".pdan-start input").eq(0).val()+" "+$(".pdan-start input").eq(1).val()+":"+$(".pdan-start input").eq(2).val(),r=$(".pdan-end input").eq(0).val()+" "+$(".pdan-end input").eq(1).val()+":"+$(".pdan-end input").eq(2).val();return""===a||""===l||""===g||"选择快递模板"===g||""===$(".pdan-start input").eq(1).val()||""===$(".pdan-end input").eq(1).val()||""===$(".pdan-start input").eq(2).val()||""===$(".pdan-end input").eq(2).val()?(alert("标题，分类，快递模板，拼团开始时间，拼团结束时间为必填项！"),!1):void 0===i||void 0===t?(alert("请先上传图片！"),!1):0===All.length?(alert("请先点击保存按钮！"),!1):void($(".pdan-start input").eq(1).val()-0>=24||$(".pdan-end input").eq(1).val()-0>=24||$(".pdan-start input").eq(2).val()-0>=60||$(".pdan-end input").eq(2).val()-0>=60?alert("时间有误!时间格式为24小时制"):0===push_stu&&(push_stu=1,$.post(localhost+"/tuan/product/save",{pname:a,types:l,deliver:g,style:e,detailPic:i,indexPic:t,tprotypes:All.join("="),saleId:token,online_code:onlinecode,parameters:o,tuanNumbers:p,tuanTimes:c,active:n.active,id:n.id,isTuan:n.isTuan,saleNum:n.saleNum,start_date:d,end_date:r,suffix:s},function(i){outline(i),"操作成功"===i.message?(alert("更新成功！"),push_stu=0,location.href="fix_pin.html"):(alert(i.message),push_stu=0)})))})});
/*2018-01-05*/